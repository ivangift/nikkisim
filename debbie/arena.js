const _template = `// coins: 现有代币
// ask: 黛奥比索要代币数
// gives: 自从上次暴击后已经给过多少次
// potential: 剩余可获得代币
// quota: 剩余可自由支配代币，不收集衣服的时候没用
// return true|false，表示给或者不给
return false;
`;

const _preset = {
  'Template': _template,
  'IP不收集衣服': `if (coins * 3 > potential) return true;
if (gives < 2) {
  return ask <= 28;
}
return ask >= 18;
  `,
  'IP收集衣服': `if (quota >= potential + ask) return true;
if (gives < 2) {
  return ask <=18;
}
return ask >=24;    
  `,
  '盲目': `return true;`,
  'IP为了不收集衣服玩了票大的': `m = {
    "0": {
      "18": [
        6.0164421844613285, 
        -0.04807908411543133, 
        -9.637516032703262
      ], 
      "19": [
        2.2769279257232715, 
        -0.010607893010253826, 
        -44.055652873004654
      ], 
      "20": [
        1.2703603938872094, 
        -0.008593426545069244, 
        -31.811459487329216
      ], 
      "21": [
        0.8805088618618538, 
        -0.007758329934385184, 
        -26.928984524384184
      ], 
      "22": [
        0.4375267034619954, 
        -0.005274014477030557, 
        -15.989551877379329
      ], 
      "23": [
        0.354917536742123, 
        -0.005413878906342036, 
        -14.616250046951535
      ], 
      "24": [
        0.324249790881753, 
        -0.006405172705065436, 
        -14.416061278999807
      ], 
      "25": [
        0.303193196623167, 
        -0.007981003148132607, 
        -14.089044827631648
      ], 
      "26": [
        0.29864756242342566, 
        -0.010497552799771374, 
        -14.056376727560536
      ], 
      "27": [
        0.37961939730186034, 
        -0.017489743864837187, 
        -17.35153138334795
      ], 
      "28": [
        0.18352884448341963, 
        -0.011960079284968422, 
        -7.620646073901012
      ], 
      "29": [
        0.18084764988126967, 
        -0.014853955364046618, 
        -6.6271174060807665
      ], 
      "30": [
        0.23381506372956012, 
        -0.022558185257656172, 
        -7.725910078983659
      ], 
      "31": [
        0.2811878345807961, 
        -0.030969798750258314, 
        -8.397679157217205
      ], 
      "32": [
        0.3968163353100291, 
        -0.048103374910137095, 
        -11.021367292695802
      ], 
      "33": [
        0.19756876461405795, 
        -0.026971922116110495, 
        -4.676817301579795
      ], 
      "34": [
        0.4211161553954541, 
        -0.05960779664769472, 
        -10.456277638224837
      ], 
      "35": [
        0.2254275971977705, 
        -0.034670984865078296, 
        -4.9417648218710655
      ], 
      "36": [
        0.403335506900102, 
        -0.06401201325653792, 
        -9.194521509284996
      ], 
      "37": [
        0.22338036868395078, 
        -0.037897904263244755, 
        -4.434204133441831
      ], 
      "38": [
        0.38184779725823675, 
        -0.06614372698269635, 
        -8.190595078417449
      ], 
      "39": [
        0.39980329742139525, 
        -0.07153484401138464, 
        -8.72971618216192
      ], 
      "40": [
        0.40934752003538993, 
        -0.07570054388674041, 
        -8.734755730212266
      ], 
      "41": [
        0.2888505089734173, 
        -0.05567154084104739, 
        -5.51225532544469
      ], 
      "42": [
        0.3872553736237318, 
        -0.07599051659255018, 
        -7.841092035169847
      ], 
      "43": [
        0.37051740972720404, 
        -0.07457161838892341, 
        -7.379435403056864
      ], 
      "44": [
        0.18205267708834963, 
        -0.039166415473121, 
        -1.9168937718135906
      ], 
      "45": [
        0.24467985812061854, 
        -0.05231839492785922, 
        -3.900797418219164
      ], 
      "46": [
        0.24913870606509536, 
        -0.05423486749352883, 
        -3.9616920458851546
      ], 
      "47": [
        0.4176751692497709, 
        -0.09091156465446827, 
        -8.059199197795692
      ], 
      "48": [
        0.2511602663539043, 
        -0.05646589741280823, 
        -3.9542664019911005
      ], 
      "49": [
        0.17210958599286247, 
        -0.04138433518261935, 
        -0.3778846994405003
      ], 
      "50": [
        0.24399910165944294, 
        -0.05644964015176297, 
        -3.7478615284429115
      ]
    }, 
    "1": {
      "15": [
        3.5097748395398565, 
        -0.007985765886594677, 
        -48.73320815926951
      ], 
      "16": [
        1.7205150987729223, 
        -0.00687659966256497, 
        -34.11739921122006
      ], 
      "17": [
        1.2314948817511076, 
        -0.0056323219930604854, 
        -31.136751640317513
      ], 
      "18": [
        0.9700424151985709, 
        -0.0050513168586109715, 
        -29.054542122296937
      ], 
      "19": [
        0.814286919788501, 
        -0.0053033655256905735, 
        -27.50760678524447
      ], 
      "20": [
        0.6135692199651596, 
        -0.004876711855466546, 
        -23.443537994447833
      ], 
      "21": [
        0.518849459389629, 
        -0.004650729016214091, 
        -22.098064106691563
      ], 
      "22": [
        0.49574666642172016, 
        -0.00518231307905375, 
        -22.793440705119455
      ], 
      "23": [
        0.4251584234506571, 
        -0.005913920432201836, 
        -20.546480468982146
      ], 
      "24": [
        0.40131541736904613, 
        -0.007557317543209883, 
        -20.01945858534471
      ], 
      "25": [
        0.3541306408671239, 
        -0.009048874798079214, 
        -18.071283760839314
      ], 
      "26": [
        0.27582484016044956, 
        -0.009739892069253643, 
        -14.041368896758609
      ], 
      "27": [
        0.3823590929395698, 
        -0.017542601128949946, 
        -18.565992597428313
      ], 
      "28": [
        0.4135543475278585, 
        -0.024940656322476294, 
        -18.480512352500703
      ], 
      "29": [
        0.17896636853721154, 
        -0.014551517217064231, 
        -6.9433695567450116
      ], 
      "30": [
        0.21148709657485698, 
        -0.020346277473280015, 
        -7.2881516335211565
      ], 
      "31": [
        0.18620145106741368, 
        -0.02093500321544855, 
        -5.521805863955019
      ], 
      "32": [
        0.19572163301111725, 
        -0.02437927333577325, 
        -5.319478564714907
      ], 
      "33": [
        0.38331990862059495, 
        -0.05036563916511637, 
        -10.400605463295635
      ], 
      "34": [
        0.3860689285173823, 
        -0.054480436566595444, 
        -9.944474226311812
      ], 
      "35": [
        0.4084597026894355, 
        -0.06121807040736287, 
        -10.066864537283784
      ], 
      "36": [
        0.42070238961874634, 
        -0.0664486794284847, 
        -9.986722848724472
      ], 
      "37": [
        0.4028686453402516, 
        -0.06648252886544967, 
        -9.538019961897534
      ], 
      "38": [
        0.22653422011933724, 
        -0.03978015674080809, 
        -4.574660737788716
      ], 
      "39": [
        0.38495197576421775, 
        -0.06885544846648957, 
        -8.381665424755036
      ], 
      "40": [
        0.38702210174607116, 
        -0.07135912735388612, 
        -8.514695087133827
      ], 
      "41": [
        0.3946116764666805, 
        -0.07496692333301402, 
        -8.514377847724344
      ], 
      "42": [
        0.3856302942625226, 
        -0.07530812228639086, 
        -8.166668812963628
      ], 
      "43": [
        0.37028780104613024, 
        -0.07423317733522677, 
        -7.613752883243622
      ], 
      "44": [
        0.35571649397851957, 
        -0.07296309363253774, 
        -7.204787389269345
      ], 
      "45": [
        0.1798981981601379, 
        -0.039149352896253875, 
        -2.1382508215628504
      ], 
      "46": [
        0.1775466095653294, 
        -0.03962949676984874, 
        -1.7211417784553171
      ], 
      "47": [
        0.24286321894852464, 
        -0.053511207744045, 
        -3.9898039717395624
      ], 
      "48": [
        0.36057798411646785, 
        -0.07944898893910862, 
        -7.122072969824602
      ], 
      "49": [
        0.23348805267999528, 
        -0.05311979479868978, 
        -3.6654743525634994
      ], 
      "50": [
        0.23299200618789542, 
        -0.05370397905689771, 
        -3.64123589780044
      ]
    }, 
    "2": {
      "6": [
        0.22912193577801543, 
        -0.08617632503205155, 
        -0.13878382596989777
      ], 
      "7": [
        0.3031945459626065, 
        -0.10714843022796637, 
        -0.08187477238810845
      ], 
      "8": [
        0.3625584080203886, 
        -0.12084291700690439, 
        -0.08816506533486954
      ], 
      "9": [
        0.5194662751873453, 
        -0.16323954302393578, 
        -0.1707776754906069
      ], 
      "10": [
        0.4482754215010341, 
        -0.13281170015703778, 
        -0.02985306289253513
      ], 
      "11": [
        0.36530500863769416, 
        -0.10133927905073825, 
        -0.009381192323980207
      ], 
      "12": [
        0.35549403293978704, 
        -0.09114363300249598, 
        -0.007871459148144203
      ], 
      "13": [
        0.3639814889065291, 
        -0.08417291747206099, 
        -0.01081768503354619
      ], 
      "14": [
        0.45140672021908945, 
        -0.08955747729552284, 
        -0.19409930919073418
      ], 
      "15": [
        0.3436354086099986, 
        -0.054682163518170235, 
        -2.4546141631208735
      ], 
      "16": [
        0.3802704427843242, 
        -0.04423465102908181, 
        -6.474200747837677
      ], 
      "17": [
        0.251460039936392, 
        -0.017724095191259285, 
        -7.823453180384979
      ], 
      "18": [
        0.2765749317364286, 
        -0.00922229774235647, 
        -11.801163736616031
      ], 
      "19": [
        0.3138667672920241, 
        -0.005278195813203161, 
        -13.671469133188728
      ], 
      "20": [
        0.4563469248277924, 
        -0.004763542167471711, 
        -18.19095788346602
      ], 
      "21": [
        0.6837314236639062, 
        -0.005855102926791422, 
        -22.26785037499719
      ], 
      "22": [
        1.2495633278119949, 
        -0.01405534929448866, 
        -17.66357160930872
      ]
    }
  };
  if (gives > 2) gives = 2;
  if (m[gives][ask]) {
    return m[gives][ask][0] * coins + m[gives][ask][1] * potential + m[gives][ask][2] > 0;
  }
  return true;`,
}

const USER_SCRIPT = "userScript";

class SampleCollector {
  log(event) { this.logs.push(event); }
  reset() { this.logs = []; }
}

const logger = new SampleCollector()
const env = new Environment("default", logger);

function noop() {
  return false;
}

function genAgent() {
  return new Function("coins", "ask", "gives", "potential", "quota", $("#agentScript").val());
}

const numFormat = new Intl.NumberFormat("en-US", { useGrouping: false, maximumFractionDigits: 3 });

function stats(scores) {
  let total = 0;
  let max = 0;
  let min = 1e99;
  let square = 0;
  scores.forEach(e => {
    total += e;
    square += e * e;
    if (e > max) {
      max = e;
    }
    if (e < min) {
      min = e;
    }
  });
  const avg = total / scores.length;
  const stdev = Math.sqrt(square / scores.length - avg * avg);

  return `Average: ${numFormat.format(avg)}&#177;${numFormat.format(stdev)}<br/>
    'Max': ${max}<br/>
    'Min': ${min}<br/>`
}

function doBenchmark(f) {
  let scores = [];
  for (let i = 0; i < 1000; i++) {
    env.reset($("#challenge").val());
    while (!env.finished()) {
      if (!env.canGive()) {
        env.decide(false);
      } else {
        env.decide(f(env.coin, env.ask, env.criticalCounter, env.potential(), env.quota()));
      }
    }
    scores.push(env.score());
  }
  $("#stats").html(stats(scores));
  $("#history").html(logger.logs.join(''));
}

function onRun() {
  $("#error").empty();
  try {
    const f = genAgent();
    doBenchmark(f);
  } catch (e) {
    $("#error").text(e);
  }
  if ($("#preset").val() == USER_SCRIPT || !localStorage.userScript) {
    localStorage.userScript = $("#agentScript").val();
  }
}

function onPreset() {
  const option = $("#preset").val();
  if (option == USER_SCRIPT) {
    $("#agentScript").val(localStorage.userScript);
  } else {
    $("#agentScript").val(_preset[option]);
  }
}

function init() {
  $("#agentScript").text(_template);
  $("#run").click(onRun);
  for (let key in _preset) {
    $("#preset").append($('<option />')
      .text(key)
      .val(key)
    )
  }
  if (localStorage.userScript) {
    $("#preset").append($('<option />')
      .text("用户自定义")
      .val(USER_SCRIPT)
      .attr('selected', 'selected'));
  }
  onPreset();
  $("#preset").change(onPreset);
}

$(document).ready(function () {
  init()
});
